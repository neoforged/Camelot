import java.util.stream.Collectors
import java.util.stream.IntStream

plugins {
    id 'java-library'
}

java.toolchain.languageVersion = JavaLanguageVersion.of(25)

dependencies {
    api(libs.jda)
    api(libs.bundles.database)
    implementation(libs.caffeine)
    implementation(libs.json)
    compileOnly(libs.annotations)

    testRuntimeOnly(libs.logback)
}

tasks.register('createObjectOption') {
    doLast {
        final int maxArgs = 10

        final file = project.file('src/main/java/net/neoforged/camelot/api/config/type/ObjectOptionBuilders.java')
        final interfaceBuilder = new StringBuilder("""
package net.neoforged.camelot.api.config.type;

import java.util.List;
import java.util.function.Function;
import java.util.function.UnaryOperator;

// This file is autogenerated. DO NOT MODIFY IT MANUALLY
public interface ObjectOptionBuilders {""".trim())

        for (int i = 1; i <= maxArgs; i++) {
            var genericList = argList(i)
            String moreArgs = ""
            if (i < maxArgs) {
                moreArgs = """
        /**
         * Add a field to this composite object.
         *
         * @param id                   the id of the field
         * @param extractor            the function that extracts the field value from the object
         * @param fieldFactory         the option factory to create the field's option
         * @param optionConfigurator   a unary operator used to configure the field option
         * @param <NEW>                the type of the field to add
         * @param <FROM>               the type of the option factory. This can be different to facilitate eventual mapping
         * @param <FB>                 the type of the field's builder
         * @return a new builder with the added field
         */
        <NEW, FROM, FB extends OptionBuilder<TGT, FROM, FB>> Builder${i + 1}<TGT, OBJ, ${genericList}, NEW> field(String id, Function<OBJ, NEW> extractor, OptionBuilderFactory<TGT, FROM, FB> fieldFactory, Function<FB, ? extends OptionBuilder<TGT, NEW, ?>> optionConfigurator);

        /**
         * Add a field to this composite object.
         *
         * @param id                   the id of the field
         * @param extractor            the function that extracts the field value from the object
         * @param fieldFactory         the option factory to create the field's option
         * @param displayName          the display name of the field
         * @param description          the description of the field
         * @param defaultValue         the default value of the field
         * @param <NEW>                the type of the field to add
         * @return a new builder with the added field
         */
        <NEW> Builder${i + 1}<TGT, OBJ, ${genericList}, NEW> field(String id, Function<OBJ, NEW> extractor, OptionBuilderFactory<TGT, NEW, ?> fieldFactory, String displayName, String description, NEW defaultValue);""".trim()
            }
            interfaceBuilder.append("""
    /**
     * A builder for composite objects with ${i} fields.
     */
    interface Builder${i}<TGT, OBJ, ${genericList}> {
        ${moreArgs}
        /**
         * {@return an option builder factory for object options of this type}
         * The fields will be turned into the object using the given {@code constructor}.
         *
         * @param constructor the function used to construct the object from the fields
         */
        OptionBuilderFactory<TGT, OBJ, OptionBuilder.Composite<TGT, OBJ>> construct(Constructor${i}<${genericList}, OBJ> constructor);
    }
""")
        }

        for (int i = 1; i <= maxArgs; i++) {
            interfaceBuilder.append("""
    /**
     * A constructor function with ${i} argument${i == 1 ? '' : 's'}.
     */
    interface Constructor${i}<${argList(i)}, RESULT> {
        /**
         * {@return the object constructed with the given arguments}
         */
        RESULT create(${IntStream.range(0, i).mapToObj { "${genericArg(it)} arg${it}"}.collect(Collectors.joining(', '))});

        /**
         * {@return the object constructed with the given arguments}
         *
         * @param arguments the arguments as an ordered list
         */
        @SuppressWarnings("unchecked")
        default RESULT createFromList(List<Object> arguments) {
            return create(${IntStream.range(0, i).mapToObj { "(${genericArg(it)}) arguments.get($it)"}.collect(Collectors.joining(', '))});
        }
    }""")
        }

        interfaceBuilder.append('\n}')

        file.delete()
        file << interfaceBuilder

        final builderFile = project.file('src/main/java/net/neoforged/camelot/api/config/impl/ObjectOptionBuilder.java')
        builderFile.delete()
        builderFile << ("""
package net.neoforged.camelot.api.config.impl;

import net.neoforged.camelot.api.config.type.ObjectOptionBuilders;
import net.neoforged.camelot.api.config.type.OptionBuilder;
import net.neoforged.camelot.api.config.type.OptionBuilderFactory;

import java.util.ArrayList;
import java.util.List;
import java.util.function.Function;

// This file is autogenerated. DO NOT MODIFY IT MANUALLY
@SuppressWarnings({"rawtypes", "unchecked"})
record ObjectOptionBuilder<G, O>(List<ObjectOption.BuilderOption<G, O, ?, ?>> options) implements ${IntStream.rangeClosed(1, maxArgs).mapToObj { 'ObjectOptionBuilders.Builder' + it }.collect(Collectors.joining(', '))} {
    ObjectOptionBuilder(List<ObjectOption.BuilderOption<G, O, ?, ?>> previous, ObjectOption.BuilderOption<G, O, ?, ?> extra) {
        var newOptions = new ArrayList<>(previous);
        newOptions.add(extra);
        this(newOptions);
    }

    @Override
    public ObjectOptionBuilder<G, O> field(String id, Function extractor, OptionBuilderFactory factory, Function configurator) {
        return new ObjectOptionBuilder<>(this.options, new ObjectOption.BuilderOption<>(id, extractor, factory, configurator));
    }
    
    @Override
    public ObjectOptionBuilder<G, O> field(String id, Function extractor, OptionBuilderFactory fieldFactory, String displayName, String description, Object defaultValue) {
        return field(id, extractor, fieldFactory, b -> ((OptionBuilder) b).displayName(displayName).description(description).defaultValue(defaultValue));
    }
${IntStream.rangeClosed(1, maxArgs).mapToObj {"""
    @Override
    public OptionBuilderFactory construct(ObjectOptionBuilders.Constructor$it constructor) {
        return new ObjectOption.Factory(this.options, constructor::createFromList);
    }
"""}.collect(Collectors.joining())}
}
""".trim())
    }
}

static String argList(int count) {
    IntStream.range(0, count).mapToObj(this.&genericArg).collect(Collectors.joining(', '))
}

static String genericArg(int nr) {
    return String.valueOf((char)(((int)(char)'A') + nr))
}
